\chapter{Experiment Outlining}

\section{Overview of Experiment Outlining}
Each experiment comprises sixteen hours of video recording spanning both awake and asleep epochs.
Since we are only interested in the behavioral repertoire exhibited during sleep, time intervals where the animal is dormant, namely the dormancy epochs, should be detected before proceeding with the behavior mapping stage.
We characterize dormancy epochs by lack of macro-activities, i.e., significant postural and locational changes, which can be qualified by displacement of the animal.
After detecting and excluding intervals of macro-activities, we end up with time points where the fly is dormant.
Yet, we need further process the dormancy epochs, as we are not interested in the time points where the fly is totally quiescent.
Our major focus is on the micro-activity bouts manifested during a dormancy epoch.
In order to detect those bouts, we should distinguish micro-activities exhibited during dormant epochs from macro-activities by quantifying them with a closer look at various body parts. We use the term ``bouts'' and ``epochs'' respectively for micro-activities and macro-activities to reflect their difference in terms of duration. As discussed in Section~\ref{section:analyzing-behavioral-repertoire}, behaviors categorized in micro-activities are tends to have shorter durations, compared to macro-activities.

In this stage, our ultimate goal is to extract bouts of micro-activities exhibited during the dormancy state.
Extracted micro-activity bouts constitute the data points that are subject to behavior mapping.
There are several benefits of reducing the data points to this subset of dormancy and micro-activity, compared to using the entire experiment for behavior mapping.
Considering the high frame rate and long length of video recordings, computational requirements are an important concern in our pipeline.
Since roughly at least $90\%$ of the frames are either totally quiescent or macro-activities, e.g., walking, this approach has the benefit of reducing the computational requirements significantly.
Another critical point is that, quiescence, e.g., rest, frames contain only noise energy, and normalizing each frame amplifies me normalization amplifies this low-level noise energy, generating a uniform-like probability distribution for behavioral representation \citep{todd_systematic_2017}.
Eliminating totally quiescence frames without any micro-activity avoids this.
Also, as we are only interested in the behaviors exhibited during sleep, excluding macro-activity frames prevent domination of large number of frames with walking and macro-activities in the behavioral embedding space.

\NOTE{Overview of sections.}

\section{Quantifying Activities}
\subsection{Dormancy and Macro-activity Epochs}
When the fly is awake, many behaviors are manifested by featuring major postural changes and displacement of the body in different ways.
We categorize this type of behaviors under the umbrella term of macro-activity, and dormancy is defined as the lack of macro-activities, covering micro-activities.
One can characterize macro-activities without considering its sub-categories by using the velocities, i.e., gradient features.
In order to distinguish sub-categories of macro-activities, such as walking and rearing, more detailed and descriptive features are required.
However, in our case, computing a single scalar value to capture overall movement of the fly results in sufficient performance for detecting macro-activity epochs. We define this feature value by summing gradient features for all time scales, utilizing the dynamic postural feature tensor $M^\mu$, as follows:
\begin{equation}\label{equation:displacement}
	v_t = \sum_{\tau \in \mathcal{T}_G}{\sum_{i=1}^{N_G}{\mu_\tau\rbr{g_i,t}}},
\end{equation}
where the resulting velocity-based feature vector is $\V{v}=\rbr{v_1, \cdots, v_T}$. Essentially, high and low values of $v_t$ indicate macro-activity and dormancy, respectively. Micro-activities can not be detected using such a straightforward and general value, and therefore, can not be distinguished from dormancy by using only this quantity.

\subsection{Micro-activity Bouts}
Behaviors exhibited during dormancy epochs are not necessarily accompanied by postural changes and displacement of the animal's body.
For instance, pumping-like movement of the proboscis or switch-like movement of haltere tends to happen independent of the rest of the body.
Thus, one need to consider more than a single scalar value, as in the previous case of macro-activity.
For each snapshot feature $s_i$, we sum all frequency channels $f$, i.e., time scales, utilizing the dynamic postural feature tensor $W$, as follows:
\begin{equation}
	u_{t,i} = \sum_{\sfrac{1}{f} \in \mathcal{T}_G}{W_f^0\rbr{s_i,t}} \qbor
	u_{t,i} = \max_{\sfrac{1}{f} \in \mathcal{T}_G}{W_f^0\rbr{s_i,t}}.
\end{equation}
The resulting feature vectors, $\V{u}_i=\rbr{u_{i,1}, \cdots, u_{i,T}}$, are representative enough for capturing micro-activities as an umbrella category.
Such micro-activities potentially occur independently of the rest of the body.
For example, using the snapshot feature of the distance between haltere and posterior thorax, we are able to detect the switch-like movement of haltere in dormancy epochs, even if the rest of the body is at rest.

\section{Detecting Activities}
\subsection{Unsupervised Approach}
The straightforward approach for detecting macro activities would be determining a global threshold based the distribution of the values of $\V{v}$.
Instead of determining such a threshold value, denoted by $c$, we use treat the distribution of $\V{v}$ as a mixture of Gaussian distributions to detect an appropriate threshold value, separately for each experiment.
This approach avoids the hassle of dealing with the varying distributions of $\V{v}$ among different experiments, and constitute a solid ground for threshold value.

Consider a mixture of univariate Gaussian distributions with $K$ components, $z=1, \cdots, K$, sorted by their corresponding mean values $\mu_1, \cdots, \mu_K$, and with full covariance matrices. Then we can define $K-1$ many decision boundaries by:
\begin{equation}
	\CondProb{V=\delta_k}{z=k} = \CondProb{V=\delta_k}{z=k+1},
\end{equation}
where $k=1, \cdots, K-1$, $V$ denotes a random variable for values of $v_t$ and $\delta_k$ is the threshold value for the $k$th decision boundary.
After computing decision boundaries for the mixture of Gaussian distributions, the macro-activity threshold is set to either one of the decision boundaries ($\delta_k$ for $k=1, \cdots, K-1$) or one of the means ($\mu_k$ for $k=1, \cdots, K$).
For example, a reasonable choice would be $K=2$ and threshold $c=\mu_2$, or $K=3$ and threshold $c=\delta_2$.
Classification is done by constructing the following frame sets:
\begin{equation}
	\begin{aligned}
		\Dormancy      & =\Set{t}{v_t \leq c, \ 1\leq t \leq T}, \\
		\MacroActivity & =\Set{t}{v_t<c, \ 1\leq t \leq T}.
	\end{aligned}
\end{equation}

We follow a similar approach for detecting micro-activities.
Since we look for micro-activities in dormancy epochs, now we only consider the frames from the set $\Dormancy$.
As micro-activity bouts are quantified by multiple feature vectors, we determine separate threshold values for each $\V{u}_i$, using the same approach with macro-activity detection, utilizing a mixture of Gaussian distributions.
After determining thresholds $c_i$ for each $\V{u}_i$, we construct the following frame sets:
\begin{equation}
	\begin{aligned}
		\Quiescence    & = \Set{t}{\bigwedge\nolimits_{i=1}^{N_G} u_{t,i} \leq c_i, \ t \in \Dormancy}, \\
		\MicroActivity & = \Set{t}{\bigvee\nolimits_{i=1}^{N_G} u_{t,i} > c_i, \ t \in \Dormancy}.
	\end{aligned}
\end{equation}
For a frame to be outlined as micro-activity, it is sufficient if at least one feature is above the corresponding threshold.
This is due to the fact that, micro-activities are manifested by changes of only a small subset of body-parts locations.

\subsection{Supervised Approach}
